#!/bin/bash

# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å –≤—ã–±–æ—Ä–æ–º —Ä–µ–∂–∏–º–∞)
cd "$(dirname "$0")/.."

echo "=========================================="
echo "   –ó–∞–ø—É—Å–∫ –º—ë—Ä–¥–∂–µ—Ä"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É..."
if curl -s --connect-timeout 3 https://google.com > /dev/null 2>&1; then
    HAS_INTERNET=true
    echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    HAS_INTERNET=false
    echo "‚ö†Ô∏è  –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""

# –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
if [ "$HAS_INTERNET" = true ]; then
    echo "üì° –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:"
    echo "   1) –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)"
    echo "   2) –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ)"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä (1 –∏–ª–∏ 2): " MODE_CHOICE

    if [ "$MODE_CHOICE" = "1" ]; then
        USE_LOCAL_MODE=false
        echo "‚òÅÔ∏è  –í—ã–±—Ä–∞–Ω –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º"
    else
        USE_LOCAL_MODE=true
        echo "üîß –í—ã–±—Ä–∞–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º"
    fi
else
    echo "‚ÑπÔ∏è  –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º"
    USE_LOCAL_MODE=true
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –∏ –æ–±—Ä–∞–∑—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
if [ "$USE_LOCAL_MODE" = true ]; then
    echo ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker
    if ! docker info &> /dev/null; then
        echo "‚ùå Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        echo ""
        echo "üì¶ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞:"
        echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ Docker Desktop (–∏–∫–æ–Ω–∫–∞ –∫–∏—Ç–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º –º–µ–Ω—é)"
        echo "   2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∫–∞ Docker –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è"
        echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞..."
        exit 1
    fi

    echo "‚úì Docker –∑–∞–ø—É—â–µ–Ω"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞–∑–æ–≤
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞..."
    if ! docker images | grep -q "bff-service.*local\|files-service.*local\|projects-service.*local\|generator-service.*local\|postgres.*15"; then
        echo "‚ùå Docker –æ–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo ""
        echo "üì• –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É:"
        echo "   cd '/Users/germanmironchuc/Desktop/pet projects/test'"
        echo "   ./local.bash"
        echo ""
        echo "   –≠—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç –≤—Å–µ Docker –æ–±—Ä–∞–∑—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞..."
        exit 1
    fi

    echo "‚úì Docker –æ–±—Ä–∞–∑—ã –≥–æ—Ç–æ–≤—ã (offline —Ä–µ–∂–∏–º)"
else
    echo ""
    echo "‚òÅÔ∏è  –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º - Docker –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
fi

echo ""
echo "[1/3] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
if [ "$USE_LOCAL_MODE" = true ]; then
    docker-compose -f docker-compose.local.yml down 2>/dev/null || true
else
    echo "   (–ü—Ä–æ–ø—É—Å–∫ - –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)"
fi

echo ""
echo "[2/3] –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."

if [ "$USE_LOCAL_MODE" = true ]; then
    echo "    (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)"

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (–ë–ï–ó —Å–±–æ—Ä–∫–∏)
    echo "‚úì –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
    docker-compose -f docker-compose.local.yml up -d

    # –ñ–¥—ë–º –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
    echo ""
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    sleep 15

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ BFF —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
    if curl -s http://localhost:8000 >/dev/null 2>&1; then
        echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å—ã –µ—â—ë –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ..."
        sleep 10
    fi
else
    echo "‚úÖ –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º - –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è"
fi

echo ""
echo "[3/3] –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
cd frontend

# –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É release –µ—Å–ª–∏ –æ–Ω–∞ –º–µ—à–∞–µ—Ç
if [ -d "release" ]; then
    rm -rf release
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [ ! -d "node_modules" ]; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install
fi

echo ""
echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–µ–π—á–∞—Å..."
echo ""

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "vite\|electron" || true
sleep 2

# –û—á–∏—â–∞–µ–º –∫—ç—à Vite –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Vite..."
rm -rf node_modules/.vite 2>/dev/null || true

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
if [ "$USE_LOCAL_MODE" = true ]; then
    echo "‚ÑπÔ∏è  –†–µ–∂–∏–º: –õ–æ–∫–∞–ª—å–Ω—ã–π (localhost)"
    echo "‚ÑπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: –∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
    echo ""

    # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º .env.local –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    echo "VITE_BACKEND_LOCAL=true" > .env.local

    echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ..."
    echo "   (Vite + Electron)"
    echo ""

    # –ó–∞–ø—É—Å–∫–∞–µ–º dev:electron:local
    yarn dev:electron:local
else
    echo "‚ÑπÔ∏è  –†–µ–∂–∏–º: –û–±–ª–∞—á–Ω—ã–π (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)"
    echo "‚ÑπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: –∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
    echo ""

    # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º .env.local –¥–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    echo "VITE_BACKEND_LOCAL=false" > .env.local

    echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –æ–±–ª–∞—á–Ω–æ–º —Ä–µ–∂–∏–º–µ..."
    echo "   (Vite + Electron)"
    echo ""

    # –ó–∞–ø—É—Å–∫–∞–µ–º dev:electron:cloud
    yarn dev:electron:cloud
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
cleanup() {
    echo ""
    echo "üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..."

    # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Vite –∏ Electron
    echo "üì¶ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Vite –∏ Electron..."
    pkill -f "vite\|electron" || true
    sleep 2

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
    if [ "$USE_LOCAL_MODE" = true ]; then
        echo "üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        cd "$(dirname "$0")/.."
        docker-compose -f docker-compose.local.yml down 2>/dev/null || true
    fi

    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
# EXIT - –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞, SIGINT - Ctrl+C, SIGTERM - kill
trap cleanup EXIT SIGINT SIGTERM

# –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)
wait
